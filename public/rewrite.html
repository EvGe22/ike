<html>
  <head>
    <title>Buildin' Them Electric Dictionaries</title>
    <script src="http://fb.me/react-0.12.2.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <style>
      .prefix { color: blue; font-weight: bold; }
      .suffix { color: grey; }
    </style>
  </head>
  <body>
    <div id="content"></div>
    <script type="text/jsx">
      var DictionaryApp = React.createClass({
        getInitialState: function() {
          return {
            query: "",
            results: [],
            replacements: []
          };
        },
        updateResults: function() {
          if (this.state.query == '')  { return; }
          var data = {
            query: this.state.query,
            replacements: this.state.replacements,
            dictionaries: {}
          };
          var request = {
            type: "POST",
            url: "/api/execute",
            contentType: "application/json",
            data: JSON.stringify(data)
          };
          $.ajax(request).success(function(results) {
            this.setState({results: results});
          }.bind(this));
        },
        handleSubmit: function(e) {
          e.preventDefault();
          this.updateResults();
        },
        handleChange: function(e) {
          this.setState({query: e.target.value, replacements: []});
        },
        sliderCallback: function(offset, cluster, value) {
          var replacements = this.state.replacements;
          for (var i = 0; i < replacements.length; i++) {
            if (replacements[i].offset == offset) {
              break;
            }
          }
          if (i < replacements.length) {
            replacements.splice(i, i+1);
          }
          if (value < cluster.length) {
            var prefix = cluster.slice(0, value);
            var replacement = {offset: offset, clusterPrefix: prefix}; 
            replacements.push(replacement);
          }
          this.setState({replacements: replacements});
          this.updateResults();
        },
        render: function() {
          var query = this.state.query;
          console.log(this.state);
          return (
            <div>
              <InputBox query={query} handleChange={this.handleChange} handleSubmit={this.handleSubmit}/>
              <WordTokenInfos query={query} key={query} replacements={this.state.replacements} sliderCallback={this.sliderCallback}/>
              <Results results={this.state.results}/>
            </div>
          );
        }
      });

      var InputBox = React.createClass({
        render: function() {
          return (
            <form onSubmit={this.props.handleSubmit}>
              <input value={this.props.query} onChange={this.props.handleChange}/>
              <button>Submit</button>
            </form>
          );
        }
      });

      var WordTokenInfos = React.createClass({
        getInitialState: function() {
          return {infos: []};
        },
        componentDidMount: function() {
          var data = { query: this.props.query };
          var request = {
            type: "POST",
            url: "/api/wordTokenInfo",
            contentType: "application/json",
            data: JSON.stringify(data)
          };
          $.ajax(request).success(function(results) {
            this.setState({infos: results});
          }.bind(this));
        },
        render: function() {
          var createInfo = function(i) {
            return <WordTokenInfo word={i.word} cluster={i.cluster} offset={i.position.offset} key={i.position.index} sliderCallback={this.props.sliderCallback}/>
          }.bind(this);
          return <ul>{this.state.infos.map(createInfo)}</ul>;
        }
      });

      var WordTokenInfo = React.createClass({
        getInitialState: function() {
          return {sliderValue: 0};
        },
        componentDidMount: function() {
          this.setState({sliderValue: this.props.cluster.length + 1});
        },
        sliderChange: function(e) {
          var sliderValue = e.target.value;
          this.props.sliderCallback(this.props.offset, this.props.cluster, sliderValue);
          this.setState({sliderValue: e.target.value});
        },
        render: function() {
          var word = this.props.word;
          var cluster = this.props.cluster;
          var max = cluster.length + 1;
          return (
            <li>
              <div>{word}</div>
              <ClusterDisplay cluster={cluster} sliderValue={this.state.sliderValue}/>
              <ClusterSlider max={max} sliderValue={this.state.sliderValue} sliderChange={this.sliderChange} />
            </li>
          );
        }
      });

      var ClusterDisplay = React.createClass({
        render: function() {
          var cluster = this.props.cluster + 'w';
          var n = this.props.sliderValue;
          var prefix = cluster.slice(0, n);
          var suffix = cluster.slice(n, cluster.length);
          return (
            <div>
              <span className="prefix">{prefix}</span>
              <span className="suffix">{suffix}</span>
            </div>
            );
        }
      });

      var ClusterSlider = React.createClass({
        render: function() {
          var max = this.props.max;
          return (
            <div>
              <input type="range" min="0" max={max} value={this.props.sliderValue} onChange={this.props.sliderChange}/>
            </div>
          );
        }
      });

      var Results = React.createClass({
        render: function() {
          var createRow = function(row) {
            return <ResultsRow value={row.captureGroup} count={row.count} key={row.captureGroup}/>;
          }
          return <ul>{this.props.results.map(createRow)}</ul>;
        }
      });

      var ResultsRow = React.createClass({
        render: function() {
          return <li><div>{this.props.value}</div><div>{this.props.count}</div></li>;
        }
      });

      var data = {
        wordTokenInfo: [{ "word": "using", "cluster": "00011111110", "position": { "index": 0, "offset": [0, 5] } }, { "word": "information", "cluster": "10111111101", "position": { "index": 1, "offset": [7, 18] } }, { "word": "extraction", "cluster": "101111010010", "position": { "index": 2, "offset": [19, 29] } }],
        results: [{ "captureGroup": "information extraction", "count": 3 }]
      };

      React.render(<DictionaryApp data={data}/>, document.getElementById('content'));
    </script>
  </body>
</html>
